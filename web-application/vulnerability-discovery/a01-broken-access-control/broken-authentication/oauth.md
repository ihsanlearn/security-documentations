# OAuth

***

### OAuth Grant Type

OAuth grant type ini mekanisme atau alur yang dipilih oleh sebuah aplikasi untuk mendapatkan izin (access token) dari layanan pihak ketiga (e.g. Google, Facebook, Github etc.)

***

### OAuth Scope

OAuth scope ini menentukan izin akses apa saja yang diberikan pengguna untuk aplikasi. Sebagai contoh ini ketika melakukan permintaan ke daftar kontak pengguna yang mungkin akan berbeda beda pada setiap layanan OAuth yang digunakan:

```javascript
scope=contacts
scope=contacts.read
scope=contact-list-r
scope=https://oauth-authorization-server.com/auth/scopes/user/contacts.readonly
```

#### Vulnerabilities

**Scope Expansion**

Kadang developer meminta scope yang terlalu luas misalkan `scope=files.full_access` padahal aplikasi cuma butuh baca nama file saja. Ini akan menjadi bahaya ketika aplikasi ini terkena hack.

**Scope Injection/OAuth Scope Validation Bypass**

Sebagai contoh, ada sebuah aplikasi yang meminta `read_profile`. Lalu attacker mencoba intercept request dan mengganti dengan menambah `full_access_token`. OAuth service ternyata mengizinkan itu dan menampilkan di layar persetujuan user. User klik OK lalu BOOM. Sekarang aplikasi punya akses penuh ke akun user tanpa validasi. Tanpa validasi ini artinya adalah awalnya backend meminta izin read profile, lalu backend menerima response yang tidak hanya read profile. Ini menjadi sebuah bug ketika backend tidak memvalidasi apa yang ia dapatkan.

**Over Privileged Token Acceptance**

Resource server tidak peduli pada token dengan scope apapun melainkan hanya menganggap selama token itu valid maka akses diberikan. Contohnya adalah token yang sebelumnya diminta akses read bisa digunakan untuk update atau delete resource.

**OAuth Parameter Pollution**

```javascript
scope=read_profile&scope=admin // Duplicate parameter
scope=read_profile%20admin     // Separator Manipulation (can be test with comma, semicolon or other)
scope[]=read&scope[]=write     // Array Injection
```

Server kemungkinan bisa salah parsing scope tanpa menggabungkan whitelist sekaligus bypass security filters

**etc.**

***

### Authorization Code Grant Type

Menggunakan metode pemberian izin yang menggunakan pemisahan jalur komunikasi antara browser user (_front-channel_) dan server aplikasi (_back-channel_). Aplikasi/browser tidak pernah melihat kredensial user karena dilakukan _server-to-server._ Bagaimana ini bekerja?

1. Authorization Request\
   Client Application mengarahkan browser ke Authorization Endpoint milik OAuth Service. Di sini, Client Application mengirimkan parameter kritis yaitu `response_type=code, client_id, redirect_uri, scope, state`.
2. User Consent & Code Issuance\
   Setelah user melakukan autentikasi dan memberikan izin (Consent), Authorization Server mengirimkan HTTP 302 Redirect kembali ke `redirect_uri` dengan menyisipkan parameter `code` di dalam URL fragment/query
3. Access Token Request (Back-Channel / Secure Exchange)\
   Client Application menerima kode tersebut melalui browser, lalu segera mengirimkan request POST secara langsung (server-to-server) ke Token Endpoint milik OAuth Service. Request ini dilakukan di back-channel tanpa melalui browser user. Payload POST biasanya mengandung `grant_type=authorization_code, code, redirect_uri, client_secret, client_id`.
4. Token Response\
   Authorization Server memvalidasi `code` dan `client_secret`. Jika valid, server akan merespons dengan Access Token (dan opsionalnya Refresh Token) dalam format JSON.
5. Resource Access\
   Client Application sekarang memiliki Access Token untuk disertakan dalam header `Authorization: Bearer <token>` saat melakukan request ke Resource Server API.

Keterangan:

* `response_type` menentukan jenis respon apa yang diharapkan client application dan alur mana yang ingin diinisialisasi. Untuk Authorization Code Grant Type, nilainya harus `code`.
* `client_id` parameter wajib yang berisi identifier unik Client Application. Nilai ini dihasilkan saat aplikasi klien mendaftar ke layanan OAuth.
* `redirect_uri` URI yang akan dituju oleh browser pengguna saat mengirimkan kode otorisasi ke aplikasi klien. Ini juga dikenal sebagai "URI callback" atau "endpoint callback". Banyak serangan OAuth didasarkan pada eksploitasi kelemahan dalam validasi parameter ini.
* `scope` diunakan untuk menentukan data mana yang ingin diakses oleh Client Application.
* `state` menyimpan nilai unik dan _unguessable_ yang terkait dengan sesi saat ini pada Client Application. Layanan OAuth harus mengembalikan nilai persis ini dalam respons, bersama dengan _authorization code_. Parameter ini berfungsi sebagai token CSRF untuk aplikasi klien dengan memastikan bahwa permintaan ke endpoint/callback-nya berasal dari orang yang sama yang memulai alur OAuth.

***

### Implicit Grant Type

Jenis ini lebih simple daripada Authorization Code grant type karena Client Application mendapatkan access token langsung setelah user memberikan persetujuan. Akan tetapi, ini lebih tidak aman karena semua komunikasi yang terjadi dilakukan via browser yang berarti tidak ada back-channel seperti pada Authorization Code.
